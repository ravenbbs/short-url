---
import { getSession } from "auth-astro/server";
import Layout from "../layouts/Layout.astro";
import { ArrowLeft } from "lucide-react";
import { getUrlsFromUser, getUserByEmail } from "@/utils/db";

const session = await getSession(Astro.request)

const h1 = session
  ? `URLs acortadas de ${session.user?.name?.split(' ')[0]}`
  : 'Inicia sesiÃ³n para ver tus URLs'

let urls: {
  url: string;
  code: string;
}[] = []

if (session && session.user?.email) {
  const user = await getUserByEmail(session.user.email)

  if (user.success && user.data) {
    const urlsRes = await getUrlsFromUser(user.data?.id)

    if (urlsRes.success && urlsRes.data) {
      urls = urlsRes.data.map(url => url)
    }
  }
}
---

<Layout title="Mis URLs acortadas">
  <a href="/">
    <ArrowLeft />
    Ir al inicio
  </a>
  <h1>{h1}</h1>
  <ul>
    {urls.map(url => (
      <li>
        <span>{url.url}</span>
        <button value={url.code} >Copiar</button>
      </li>
    ))}
  </ul>
</Layout>

<script>
  // import { toast } from 'sonner'
  import toast from 'react-hot-toast';

  const url = window.location.origin

  const copyShortenedUrl = document.getElementsByClassName('copy-shortened-url') as HTMLCollectionOf<HTMLButtonElement>

  if (copyShortenedUrl) {
    for (const button of copyShortenedUrl) {
      button.onclick = (e) => {
        // @ts-ignore
        if (!e.target?.value) return

        try {
          // @ts-ignore
          window.navigator.clipboard.writeText(`${url}/${e.target.value}`)
          toast.success('URL copiada al portapapeles!')
        } catch {
          toast.error('No se pudo copiar la URL al portapapeles')
        }
      }
    }
  }
</script>